---
title: "Using Leaflet and htmlwidgets in a Hugo blog post"
author: "Laura DeCicco"
date: "2016-08-23"
slug: "leaflet"
tag1: "dataRetrieval"
output: USGSmarkdowntemplates::hugo
image: "static/leaflet/screenshot.png"
---

```{r setup, include=FALSE}
library(knitr)

knit_hooks$set(plot=function(x, options) {
  sprintf("<img src='/%s%s-%d.%s'/ title='%s'/>",
          options$fig.path, options$label,
          options$fig.cur, options$fig.ext,
          options$fig.cap)

})

knit_hooks$set(htmlcap = function(before, options, envir) {
  if(!before) {
    paste('<p class="caption">',options$htmlcap,"</p>",sep="")
    }
})

opts_chunk$set(
  echo=TRUE,
  fig.path="static/leaflet/",
  fig.width = 7,
  fig.height = 7,
  fig.cap = "TODO"
)
```



Get some data. In this example, we are looking for phosphorus measured throughout Wisconsin. Using `dplyr`, we filter the data to sites that have records longer than 15 years, and more than 100 measurements.

```{r echo=TRUE, message=FALSE}
library(dataRetrieval)
pCode <- c("00665")
phos.wi <- readNWISdata(stateCd="WI", parameterCd=pCode,
                     service="site", seriesCatalogOutput=TRUE)

library(dplyr)
phos.wi <- filter(phos.wi, parm_cd %in% pCode) %>%
            filter(count_nu > 50) %>%
            mutate(period = as.Date(end_date) - as.Date(begin_date)) %>%
            filter(period > 15*365)
```


Plot the sites on a map:

```{r echo=TRUE, eval=TRUE}
library(leaflet)
leafMap <- leaflet(data=phos.wi) %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(~dec_long_va,~dec_lat_va,
                   color = "red", radius=3, stroke=FALSE,
                   fillOpacity = 0.8, opacity = 0.8,
                   popup=~station_nm)

```

The following code could be generally hid from the reader using `echo=FALSE`. 


```{r echo=TRUE}
library(htmlwidgets)
library(htmltools)

currentWD <- getwd()
dir.create("static/leaflet", showWarnings = FALSE)
setwd("static/leaflet")
saveWidget(leafMap, "leafMap.html")
setwd(currentWD)


```

Then, the html that was saved with the `saveWidget` function can be called with the `iframe` html tag. It's not completely obvious to me why the path is `static/leaflet/leafMap/index.html`. If you build the Hugo project, that is where the map ends up.

```{r echo=TRUE, eval=FALSE}
<iframe seamless src="/static/leaflet/leafMap/index.html" width="100%" height="500"></iframe>
```

<iframe seamless src="/static/leaflet/leafMap/index.html" width="100%" height="500"></iframe>

One issue however is that the map itself now indexs to the home page. 